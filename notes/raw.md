---
title: "Notes for setting up Pi 4"
---

# NixOS installation

Nix is a declarative package manager. NixOS is a Linux distribution
whose configuration is declared with Nix. This seems a good thing when
dealing with multiple physical systems so I (JG) would like to try
NixOS.

## Preamble

The Pi boots from an SD card, which it also uses as its non-volatile
storage. To install any OS on a Pi one needs to write a boot image to
the card. By default our work laptops block access to removable
storage.

However, I happen to have an existing Pi running Ubuntu. I also have
an SD card reader in a USB A stick. So I plan to use my Pi to
download and write a NixOS SD image.

## You will need

- A Raspberry Pi 4 model B
- An SD card
- A micro-HDMI to normal HDMI cable 
- A monitor and USB keyboard

The latter is required because by default NixOS does not have ssh
enabled, so you'll need to log in on console. 

## The basic plan

1. Get a generic NixOS SD image from “Hydra” (which I think is the Nix
   ecosystem's continuous build server).
   
2. Boot with this.

3. Make some configuration changes and “rebuild” (not yet sure what
   that implies).
   
4. Create a custom SD image with things like ssh public key and wifi included.

The NixOS wiki has instructions for the Pi 4[^2] and claims that it is
officially supported. There is _also_ documentation at nix.dev, which
I believe is Nix's official documentation site.[^3] (I don't know what
the difference is.)

## Getting NixOS

The installation methods on the NixOS home page[^1] provide CD images,
not SD card images, so we have to get the image from Hydra at:
https://hydra.nixos.org/job/nixos/trunk-combined/nixos.sd_image.aarch64-linux
Apparently one should get the latest successful build. I did this on a
Pi running Ubuntu. The image is about 1 GB compressed.

I followed the instructions on nix.dev:
```sh
unzstd <the downloaded image.zst>
```

Then `sudo dmesg --follow` prints kernel messages so that, when you plugh
in the target SD card (to a USB socket on the Pi, with an SD reader)
you know which device is assigned. In my case that was
`/dev/sda`. Then,
```sh
sudo dd if=nixos-sd-image-XXX-aarch64-linux.img of=/dev/sda bs=4096 conv=fsync status=progress
```

(`conv=fsync` means “physically write output file data before
finishing [and] also write metadata.”) This process took 13 minutes on
the Pi 4.

Then insert this SD card and boot and we have NixOS. (I get a bunch of
Bluetooth error messages on console but I do get a prompt.)

## Initial configuration

At this point there's a `nixos` user account but both it and `root`
have empty passwords. Also, there's no wifi.

### Wifi

To get wifi, the login instructions say to start networking with 
```sh
sudo systemctl start wpa_supplicant 
```
followed by
```sh
wpa_cli
```
to configure the interface. _That_ was not trivial! Eventually I
found:
```
> add_network
```
(Which tells you which network you've added; in my case `0`.)
```
> set_network 0 ssid "Turing Guest"
OK
> set_newwork 0 psk "NETWORK PASSWORD"
OK
> enable_network 0
OK
<3>CTRL-EVENT-SCAN-STARTED
<3>CTRI-EVENT-SCAN-RESULTS
<3>Trying to associate with SSID 'Turing Guest'
<3>Associated with xx:xx:xx:xx:xx:xx
... some other stuff
> save_config
OK
```
This all works fine, only I have no idea where it saves the
configuration file. It's not in the standard place of
`/etc/wpa_supplicant/`, for instance.

None of this survives reboot.

At this point, some documentation recommends updating the Pi firmware
but I'm going to skip that. I also don't understand whether I'm
supposed to format the SD card. It doesn't seem a problem at the
moment so again I will ignore. What I think one does need to do is
write a system-wide configuration file.

## Writing a config file

```sh
nixos-generate-config
```
This comment writes `etc/nixos/configuration.nix` anf `/etc/nixos/hardware-configuration.nix` (although
the second file claims to be generated by the first). I made some
changes (mostly uncommenting and editing lines suggested in the
generated file) and then did
```sh
nixos-rebuild boot
```
That compiles a _lot_ of stuff.




[^1]: https://nixos.org/

[^2]: https://nixos.wiki/wiki/NixOS_on_ARM/Raspberry_Pi_4

[^3]: https://nix.dev/tutorials/nixos/installing-nixos-on-a-raspberry-pi
